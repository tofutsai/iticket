@using prjITicket.Models;
@{
    ViewBag.Title = "客服專用";
    Seller seller = (Session[CDictionary.SK_Logined_Member] as Member).Seller.FirstOrDefault();
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css" rel="stylesheet" />
<link rel="stylesheet" href="~/Content/Activity/ChatSeller/ChatRoom.css">
<!---SignalR要用的-->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<div class="messaging">
    <div class="inbox_msg">
        <div class="inbox_people">
            <div class="headind_srch">
                <div class="recent_heading">
                    <h4>Recent</h4>
                </div>
                <div class="srch_bar">
                    <div class="stylish-input-group">
                        <input type="text" class="search-bar" placeholder="Search">
                        <span class="input-group-addon">
                            <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
                        </span>
                    </div>
                </div>
            </div>
            <div id="memberList" class="inbox_chat">
                <!--動態塞入人員資料-->
            </div>
        </div>
        <!----------------------------------------->
        <div id="chatBox" class="mesgs">
            <div id="firstHistory" class="msg_history">
                <!--動態塞入聊天內容-->
            </div>
            <div class="type_msg" id="typeBar">
                <div class="input_msg_write">
                    <input id="txtChat" type="text" class="write_msg" placeholder="Type a message" />
                    <button id="sendChat" class="msg_send_btn" type="button">
                        <i class="fa fa-paper-plane-o" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
        <!---------------------------------------->
    </div>
</div>
@if (seller != null)
{
<script>
        $(function () {
            //SignalR代碼
            var chat = $.connection.chatHub;
            chat.client.getMsgFromCustomer = function (msg, memberId, memberName,icon) {
                //處理左邊聊天人員列表的部分
                let classActive = "";
                if ($("#memberList").children().length == 0) classActive = "active_chat";
                let $memberitem = $(`#member${memberId}`);
                if ($memberitem.length == 0) {
                    let memberListItem = `<div class="chat_list ${classActive}" id="member${memberId}" data-id="${memberId}">` +
                        '<div class="chat_people">' +
                        '<div class="chat_img">' +
                        `<img src="@Url.Content("~/images/Login/Upload")/${icon}" alt="sunil">` +
                        '</div>' +
                        '<div class="chat_ib">' +
                        '<h5>' +
                        `${memberName}` +
                        `<span class="chat_date">${getTimeString()}</span>` +
                        '</h5>' +
                        `<p>${msg}</p>` +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    $memberitem = $(memberListItem);
                    $("#memberList").append($memberitem);
                }
                else {
                    $memberitem.find(".chat_date").html(getTimeString());
                    $memberitem.find("p").html(msg);
                }
                //處理右邊聊天的部分
                let $chatContent = $(`#chat${memberId}`);
                let showOrHide = $("#chatBox").children().length == 2 ? "" : "display:none";
                $("#firstHistory").hide();
                if ($chatContent.length == 0) {
                    let show = `<div class="msg_history" style="${showOrHide}" id="chat${memberId}">` +
                        '<div class="incoming_msg">' +
                        '<div class="incoming_msg_img">' +
                        `<img src="@Url.Content("~/images/Login/Upload")/${icon}" alt="sunil">` +
                        '</div>' +
                        '<div class="received_msg">' +
                        '<div class="received_withd_msg">' +
                        `<p style="max-width:500px">${msg}</p>` +
                        `<span class="time_date">${getTimeString()}</span>` +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    $("#typeBar").before($(show));
                }
                else {
                    let msgContainer = '<div class="incoming_msg">' +
                        '<div class="incoming_msg_img">' +
                        `<img src="@Url.Content("~/images/Login/Upload")/${icon}" alt="sunil">` +
                        '</div>' +
                        '<div class="received_msg">' +
                        '<div class="received_withd_msg">' +
                        `<p style="max-width:500px">${msg}</p>` +
                        `<span class="time_date">${getTimeString()}</span>` +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    $chatContent.append(msgContainer);
                    let actualHeight = $chatContent.get(0).scrollHeight;
                    $chatContent.scrollTop(actualHeight);
                }
            }
            $.connection.hub.start().done(function () {
                chat.server.join(@seller.Member.MemberID, "@seller.Member.NickName","@seller.CompanyName");
                $('#sendChat').click(function () {
                    let msg = $("#txtChat").val();
                    if (msg == "") return;
                    $("#txtChat").val("");
                    let memberId = $("#memberList .active_chat").data("id");
                    let msgContainer = '<div class="outgoing_msg">' +
                        '<div class="sent_msg">' +
                        `<p style="max-width:500px">${msg}</p>` +
                        `<span class="time_date">${getTimeString()}</span>` +
                        '</div>' +
                        '</div>';
                    let $chatContent = $(`#chat${memberId}`);
                    $chatContent.append($(msgContainer));
                    let actualHeight = $chatContent.get(0).scrollHeight;
                    $chatContent.scrollTop(actualHeight);
                    chat.server.send(msg,@seller.Member.MemberID, memberId, "seller");
                });
            });
            //////////////////////////////
            //點左邊的人員清單,右邊的聊天就要一起變
            $("#memberList").on("click",".chat_list",function () {
                $(this).addClass("active_chat").siblings().removeClass("active_chat");
                let memberId = $(this).data("id");
                $(".msg_history").hide();
                let $chatContent = $(`#chat${memberId}`);
                $chatContent.show();
                let actualHeight = $chatContent.get(0).scrollHeight;
                $chatContent.scrollTop(actualHeight);
            });
        });
        function getTimeString() {
            let date = new Date();
            return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        }
</script>
}